runApp('scripts_R/planning_shiny')
runApp('scripts_R/planning_shiny')
runApp('scripts_R/planning_shiny')
runApp('scripts_R/planning_shiny')
runApp('scripts_R/planning_shiny')
runApp('scripts_R/planning_shiny')
runApp('scripts_R/planning_shiny')
runApp('scripts_R/planning_shiny')
shiny::runApp('Documents/github-repositories/shiny_fluorcam')
runApp('Documents/github-repositories/shiny_fluorcam')
runApp('Documents/github-repositories/shiny_fluorcam')
runApp('Documents/github-repositories/shiny_fluorcam')
runApp('Documents/github-repositories/shiny_fluorcam')
#Define Variables
##Reference line : the line againt which the statistical tests will be performed
RefLine <- "col"  #a string between ""
## ## Order in wich the lines will appear on the plot
#target_order <- c("col", "h1", "npq1", "npq4", "h1npq1", "h1npq4")
target_order <- c("col", "g8", "h1")
setwd("~/OneDrive - Aix-Marseille Université/bio-informatique/fluorcam/Hl_Ben_Shanna/Fo")
DATA <- "0705_F0.txt"
#=======================================================================================================================================
# Check data normality. Get out of th loop if at least one of the group of data does not follow a normal law.
# return TRUE if data follow a normal law
#=======================================================================================================================================
check_normality <- function(shapiro_df) {
# The normality is assumed to be true
flag_normal <- TRUE
for (i in 1 : nrow(shapiro_df)) {
if(shapiro_df[i, 4] > 0.05) {
# print(paste0("les données ",shapiro_df$grouping_factor[i],"-",
# shapiro_df$plant_line[i], " suivent une loi normale"), quote = FALSE)
} else {
# print(paste0("les données ",shapiro_df$grouping_factor[i],"-",
#          shapiro_df$plant_line[i], " ne suivent pas une loi normale"), quote = FALSE)
# If data don't follow a normal law, don't go further
flag_normal <- FALSE
break
}
}
return(flag_normal)
}
#=======================================================================================================================================
# Take the results of Anova test
# Return TRUE if at least one mean is significantly different
#=======================================================================================================================================
check_anova <- function(anova_results) {
flag_anova <- FALSE
for (i in 1 : nrow(anova_results)) {
if (anova_results$p[i] < 0.05) {
print (paste0("Anova test compares the mean, pvalue for the group ", anova_results$param[i] , " is < 0.05 this means that at least one of the medians is significantly different from the others, a post hoc Tukey test is performed"))
flag_anova <- TRUE
} else {
print (paste0("Anova test compares the mean, pvalue for the group", anova_results$param[i] , " is > 0.05 this means that there is no significant difference between means"))
}
}
return(flag_anova)
}
#=======================================================================================================================================
# Perform Kruskal-Wallis test
# Return TRUE if one of the median is significantly different
#=======================================================================================================================================
check_kruskal <- function(kruskal_pval) {
flag_kruskal <- FALSE
for (i in 1 : nrow(kruskal_pval)) {
if (kruskal_pval$p[i] < 0.05) {
print (paste0("Kruskall Wallis test compares medians, pvalue for the group ", kruskal_pval$time[i] , " is < 0.05 this means that at least one of the medians is significantly different from the others, a post hoc Dunn test is performed"))
flag_kruskal <- TRUE
} else {
print (paste0("Kruskall Wallis test compares medians, pvalue for the group ", kruskal_pval$time[i] , " is > 0.05 this means that there is no significant difference between medians"))
}
}
return(flag_kruskal)
}
#=======================================================================================================================================
# Perform Dunn test
# Return the pvalue in a dataframe
#=======================================================================================================================================
test_dunn <- function() {
pval <- as.data.frame(df_data_long%>%
mutate(Line = fct_relevel(Line, target_order)) %>%
group_by(param) %>% dunn_test(value ~ Line, p.adjust.method = "BH"))
#print(df_data_long %>% group_by(time) %>% dunn_test(value ~ line, p.adjust.method = "BH"))
return(pval)
}
#Load the data
df_data <- read.table(DATA, header = TRUE, sep = "\t")
#Convert to long format
library(tidyr)
library(tidyverse)
#https://tidyr.tidyverse.org/reference/pivot_longer.html
df_data_long <- df_data %>% pivot_longer(!Line, names_to = "param")
library(ggbeeswarm) # for funcnction geom_quasirandom
library(RColorBrewer) # to define colors
library(rstatix)  # for statistical test
library(rcompanion) # to compute confidence interval for non parametric data
library(forcats)
library(FSA)
# Convert line's name into factor to force the order in the plot
df_data_long$Line <- as.factor(df_data_long$Line)
df_data_long$param <- as.factor(df_data_long$param)
# Determining data normality status
shapiro_df <- df_data_long %>%
dplyr::group_by(Line, param) %>%
summarise(statistic = shapiro.test(value)$statistic,
p.value = shapiro.test(value)$p.value)
flag_normal <- check_normality(shapiro_df)
# Data treatement according to normality status
if(flag_normal == TRUE) {
print("Datas follow a normal law")
# Summary
if (!require(Rmisc)) {install.packages("Rmisc")}
library(plyr) # rmisc dependance
library(Rmisc) # for the command summarySE
my_summary <- summarySE(df_data_long, measurevar="value", groupvars=c("param", "Line"))
# The 2 packages must be detach because they can prevent the goup_by function to work properly
detach(package:Rmisc)
detach(package:plyr)
# Stats
anova_results <- df_data_long %>% group_by(param) %>% anova_test(value ~ Line)
flag_anova <- check_anova(anova_results)
if (flag_anova == TRUE) {
#fit linear model
amod <- aov(value ~ Line + param, data= df_data_long)
# perform tukey
tukey_results <- emmeans::emmeans(object = amod,
pairwise ~ Line | param,
adjust = "tukey")
}
# get data for grouping by letters
tuk.cld <- cld(tukey_results$emmeans, Letters = letters)
tuk.cld <- tuk.cld[order(unlist(sapply(tuk.cld$Line,
function(x) which(target_order == x)))),]
# Save the files
write.table(my_summary, file = "Fo_Summary.txt",
quote = FALSE, row.names = FALSE, sep = '\t')
write.table(anova_results, file = "Fo_Anova.txt",
quote = FALSE, row.names = FALSE, sep = '\t')
if (flag_anova == TRUE) {
sink("Fo_Tukey.txt")
print(summary(tukey_results))
sink()
}
# Plot
p<-my_summary %>% mutate(Line = fct_relevel(Line, target_order)) %>%
ggplot(aes(x=Line, y=value))+
geom_col(aes(x=Line, y=value), color="dark grey", fill="white")+
geom_quasirandom(data = df_data_long, aes(x = Line, y = value),
color="green", width = 0.3, alpha = 0.6)+
geom_linerange(aes(x = as.factor(Line), ymin=value-ci, ymax=value+ci),
width=.2, position=position_dodge(0.9), color = "black") +
geom_text(data = tuk.cld,
aes(x = Line, y= tuk.cld$emmean , label = .group),
size = 3, position = position_dodge(0.9),
hjust = 1.5,
vjust = -2)+
scale_y_continuous(expand = expansion(mult = c(0, .1)))+
facet_wrap(~param, nrow=2)+
theme_classic()
print(p)
ggsave("Fo_plot.svg", width=8, height=6)
} else {
print("Datas don't follow a normal law")
# Summary
conf_int <- groupwiseMedian(data = df_data_long,
var = "value",
group = c("param", "Line"),
conf       = 0.95,
R          = 5000,
percentile = TRUE,
bca        = FALSE,
digits     = 3)
conf_int <- conf_int[order(unlist(sapply(conf_int$Line, function(x) which(target_order == x)))),]
# Stats
kruskal_pval <- (df_data_long %>% group_by(param)%>%kruskal_test(value ~ Line))
flag_kruskal <- check_kruskal(kruskal_pval)
if (flag_kruskal == TRUE) {
lapply(levels(df_data_long$param), function(x) {
df_data_long %>% filter(param %in% x)
}) -> Lsubdf
names(Lsubdf) <- levels(df_data_long$param)
pval_dunn <- list()
for (i in 1 : length(Lsubdf)) {
dunn <- dunnTest(x = Lsubdf[[i]][["value"]], g = Lsubdf[[i]][["Line"]], method = "bh")
pval_dunn <- c(pval_dunn, list(dunn))
}
}
names(pval_dunn) <- levels(df_data_long$param)
# Save the files
write.table(conf_int, file = "Fo_Summary.txt",
quote = FALSE, row.names = FALSE, sep = '\t')
write.table(kruskal_pval, file = "Fo_Kruskal.txt",
quote = FALSE, row.names = FALSE, sep = '\t')
if (flag_kruskal == TRUE) {
for (i in names(pval_dunn)){
write.table(pval_dunn[[i]]$res, file = paste0("Dunn_Fo_",i, ".txt"),
quote = FALSE, row.names = FALSE, sep = '\t')
}
}
# get data for grouping by letters
CLD <- list()
for (i in 1 : length(pval_dunn)) {
tmp <- cldList(P.adj ~ Comparison, data=pval_dunn[[i]]$res, remove.zero = FALSE)
tmp$Group <- as.factor(tmp$Group)
tmp <- tmp[order(unlist(sapply(tmp$Group, function(x) which(target_order == x)))),]
CLD <- c(CLD, list(tmp))
}
names(CLD) <- levels(df_data_long$param)
df_CLD <- bind_rows(CLD, .id = "param")
# Plot
p<-conf_int %>% mutate(Line = fct_relevel(Line, target_order)) %>%
ggplot(aes(x=Line, y=Median))+
geom_col(aes(x=Line, y=Median), color="dark grey", fill="white")+
geom_quasirandom(data = df_data_long, aes(x = Line, y = value),
color="green", width = 0.3, alpha = 0.6)+
geom_linerange(aes(x = as.factor(Line), ymin=Percentile.lower, ymax=Percentile.upper),
width=.2, position=position_dodge(0.9), color = "black") +
scale_y_continuous(expand = expansion(mult = c(0, .1)))+
facet_wrap(~param, nrow=2)+
theme_classic()
p + geom_text(data = df_CLD,
aes(x = Group,
y= (conf_int%>% arrange(param))$Percentile.upper,
label = Letter),
size = 3, position = position_dodge(0.9),
hjust =1.5,
vjust = -2)
ggsave("Fo_plot.svg", width=8, height=3)
}else {
# Data treatement according to normality status
if(flag_normal == TRUE) {
print("Datas follow a normal law")
# Summary
if (!require(Rmisc)) {install.packages("Rmisc")}
library(plyr) # rmisc dependance
library(Rmisc) # for the command summarySE
my_summary <- summarySE(df_data_long, measurevar="value", groupvars=c("param", "Line"))
# The 2 packages must be detach because they can prevent the goup_by function to work properly
detach(package:Rmisc)
detach(package:plyr)
# Stats
anova_results <- df_data_long %>% group_by(param) %>% anova_test(value ~ Line)
flag_anova <- check_anova(anova_results)
if (flag_anova == TRUE) {
#fit linear model
amod <- aov(value ~ Line + param, data= df_data_long)
# perform tukey
tukey_results <- emmeans::emmeans(object = amod,
pairwise ~ Line | param,
adjust = "tukey")
}
# get data for grouping by letters
tuk.cld <- cld(tukey_results$emmeans, Letters = letters)
tuk.cld <- tuk.cld[order(unlist(sapply(tuk.cld$Line,
function(x) which(target_order == x)))),]
# Save the files
write.table(my_summary, file = "Fo_Summary.txt",
quote = FALSE, row.names = FALSE, sep = '\t')
write.table(anova_results, file = "Fo_Anova.txt",
quote = FALSE, row.names = FALSE, sep = '\t')
if (flag_anova == TRUE) {
sink("Fo_Tukey.txt")
print(summary(tukey_results))
sink()
}
# Plot
p<-my_summary %>% mutate(Line = fct_relevel(Line, target_order)) %>%
ggplot(aes(x=Line, y=value))+
geom_col(aes(x=Line, y=value), color="dark grey", fill="white")+
geom_quasirandom(data = df_data_long, aes(x = Line, y = value),
color="green", width = 0.3, alpha = 0.6)+
geom_linerange(aes(x = as.factor(Line), ymin=value-ci, ymax=value+ci),
width=.2, position=position_dodge(0.9), color = "black") +
geom_text(data = tuk.cld,
aes(x = Line, y= tuk.cld$emmean , label = .group),
size = 3, position = position_dodge(0.9),
hjust = 1.5,
vjust = -2)+
scale_y_continuous(expand = expansion(mult = c(0, .1)))+
facet_wrap(~param, nrow=2)+
theme_classic()
print(p)
ggsave("Fo_plot.svg", width=8, height=6)
} else {
print("Datas don't follow a normal law")
# Summary
conf_int <- groupwiseMedian(data = df_data_long,
var = "value",
group = c("param", "Line"),
conf       = 0.95,
R          = 5000,
percentile = TRUE,
bca        = FALSE,
digits     = 3)
conf_int <- conf_int[order(unlist(sapply(conf_int$Line, function(x) which(target_order == x)))),]
# Stats
kruskal_pval <- (df_data_long %>% group_by(param)%>%kruskal_test(value ~ Line))
flag_kruskal <- check_kruskal(kruskal_pval)
if (flag_kruskal == TRUE) {
lapply(levels(df_data_long$param), function(x) {
df_data_long %>% filter(param %in% x)
}) -> Lsubdf
names(Lsubdf) <- levels(df_data_long$param)
pval_dunn <- list()
for (i in 1 : length(Lsubdf)) {
dunn <- dunnTest(x = Lsubdf[[i]][["value"]], g = Lsubdf[[i]][["Line"]], method = "bh")
pval_dunn <- c(pval_dunn, list(dunn))
}
}
names(pval_dunn) <- levels(df_data_long$param)
# Save the files
write.table(conf_int, file = "Fo_Summary.txt",
quote = FALSE, row.names = FALSE, sep = '\t')
write.table(kruskal_pval, file = "Fo_Kruskal.txt",
quote = FALSE, row.names = FALSE, sep = '\t')
if (flag_kruskal == TRUE) {
for (i in names(pval_dunn)){
write.table(pval_dunn[[i]]$res, file = paste0("Dunn_Fo_",i, ".txt"),
quote = FALSE, row.names = FALSE, sep = '\t')
}
}
# get data for grouping by letters
CLD <- list()
for (i in 1 : length(pval_dunn)) {
tmp <- cldList(P.adj ~ Comparison, data=pval_dunn[[i]]$res, remove.zero = FALSE)
tmp$Group <- as.factor(tmp$Group)
tmp <- tmp[order(unlist(sapply(tmp$Group, function(x) which(target_order == x)))),]
CLD <- c(CLD, list(tmp))
}
names(CLD) <- levels(df_data_long$param)
df_CLD <- bind_rows(CLD, .id = "param")
# Plot
p<-conf_int %>% mutate(Line = fct_relevel(Line, target_order)) %>%
ggplot(aes(x=Line, y=Median))+
geom_col(aes(x=Line, y=Median), color="dark grey", fill="white")+
geom_quasirandom(data = df_data_long, aes(x = Line, y = value),
color="green", width = 0.3, alpha = 0.6)+
geom_linerange(aes(x = as.factor(Line), ymin=Percentile.lower, ymax=Percentile.upper),
width=.2, position=position_dodge(0.9), color = "black") +
scale_y_continuous(expand = expansion(mult = c(0, .1)))+
facet_wrap(~param, nrow=2)+
theme_classic()
p + geom_text(data = df_CLD,
aes(x = Group,
y= (conf_int%>% arrange(param))$Percentile.upper,
label = Letter),
size = 3, position = position_dodge(0.9),
hjust =1.5,
vjust = -2)
ggsave("Fo_plot.svg", width=8, height=3)
} else {
View(df_data_long)
#fit linear model
amod <- aov(value ~ Line + param, data= df_data_long)
# perform tukey
tukey_results <- emmeans::emmeans(object = amod,
pairwise ~ Line | param,
adjust = "tukey")
install.packages('emmeans')
#fit linear model
amod <- aov(value ~ Line + param, data= df_data_long)
# perform tukey
tukey_results <- emmeans::emmeans(object = amod,
pairwise ~ Line | param,
adjust = "tukey")
library(plyr) # rmisc dependance
library(Rmisc) # for the command summarySE
my_summary <- summarySE(df_data_long, measurevar="value", groupvars=c("param", "Line"))
# The 2 packages must be detach because they can prevent the goup_by function to work properly
detach(package:Rmisc)
detach(package:plyr)
# get data for grouping by letters
tuk.cld <- cld(tukey_results$emmeans, Letters = letters)
tuk.cld <- emmeans::cld(tukey_results$emmeans, Letters = letters)
View(tukey_results)
install.packages('multicomp')
install.packages('multcomp')
install.packages("multcomp")
tuk.cld <- cld(tukey_results$emmeans, Letters = letters)
library(multcomp)
tuk.cld <- cld(tukey_results$emmeans, Letters = letters)
tuk.cld <- tuk.cld[order(unlist(sapply(tuk.cld$Line,
function(x) which(target_order == x)))),]
p<-my_summary %>% mutate(Line = fct_relevel(Line, target_order)) %>%
ggplot(aes(x=Line, y=value))+
geom_col(aes(x=Line, y=value), color="dark grey", fill="white")+
geom_quasirandom(data = df_data_long, aes(x = Line, y = value),
color="green", width = 0.3, alpha = 0.6)+
geom_linerange(aes(x = as.factor(Line), ymin=value-ci, ymax=value+ci),
width=.2, position=position_dodge(0.9), color = "black") +
geom_text(data = tuk.cld,
aes(x = Line, y= tuk.cld$emmean , label = .group),
size = 3, position = position_dodge(0.9),
hjust = 1.5,
vjust = -2)+
scale_y_continuous(expand = expansion(mult = c(0, .1)))+
facet_wrap(~param, nrow=2)+
theme_classic()
print(p)
View(my_summary)
p<-my_summary %>% mutate(Line = fct_relevel(Line, target_order)) %>%
ggplot(aes(x=Line, y=value))+
geom_col(aes(x=Line, y=value), color="dark grey", fill="white")+
geom_quasirandom(data = df_data_long, aes(x = Line, y = value),
color="green", width = 0.3, alpha = 0.6)+
geom_linerange(aes(x = as.factor(Line), ymin=value-ci, ymax=value+ci),
width=.2, position=position_dodge(0.9), color = "black") +
geom_text(data = tuk.cld,
aes(x = Line, y= tuk.cld$emmean , label = .group),
size = 3, position = position_dodge(0.9),
hjust = 1.5,
vjust = -2)+
scale_y_continuous(expand = expansion(mult = c(0, .1)))+
facet_wrap(~Line, nrow=2)+
theme_classic()
print(p)
p<-my_summary %>% mutate(Line = fct_relevel(Line, target_order)) %>%
ggplot(aes(x=param, y=value))+
geom_col(aes(x=Line, y=value), color="dark grey", fill="white")+
geom_quasirandom(data = df_data_long, aes(x = Line, y = value),
color="green", width = 0.3, alpha = 0.6)+
geom_linerange(aes(x = as.factor(Line), ymin=value-ci, ymax=value+ci),
width=.2, position=position_dodge(0.9), color = "black") +
geom_text(data = tuk.cld,
aes(x = Line, y= tuk.cld$emmean , label = .group),
size = 3, position = position_dodge(0.9),
hjust = 1.5,
vjust = -2)+
scale_y_continuous(expand = expansion(mult = c(0, .1)))+
facet_wrap(~Line, nrow=2)+
theme_classic()
print(p)
p<-my_summary %>% mutate(Line = fct_relevel(Line, target_order)) %>%
ggplot(aes(x=param, y=value))+
geom_col(aes(x=param, y=value), color="dark grey", fill="white")+
geom_quasirandom(data = df_data_long, aes(x = Line, y = value),
color="green", width = 0.3, alpha = 0.6)+
geom_linerange(aes(x = as.factor(Line), ymin=value-ci, ymax=value+ci),
width=.2, position=position_dodge(0.9), color = "black") +
geom_text(data = tuk.cld,
aes(x = Line, y= tuk.cld$emmean , label = .group),
size = 3, position = position_dodge(0.9),
hjust = 1.5,
vjust = -2)+
scale_y_continuous(expand = expansion(mult = c(0, .1)))+
facet_wrap(~Line, nrow=2)+
theme_classic()
print(p)
p<-my_summary %>% mutate(Line = fct_relevel(Line, target_order)) %>%
ggplot(aes(x=param, y=value))+
geom_col(aes(x=param, y=value), color="dark grey", fill="white")+
geom_quasirandom(data = df_data_long, aes(x = param, y = value),
color="green", width = 0.3, alpha = 0.6)+
geom_linerange(aes(x = as.factor(Line), ymin=value-ci, ymax=value+ci),
width=.2, position=position_dodge(0.9), color = "black") +
geom_text(data = tuk.cld,
aes(x = Line, y= tuk.cld$emmean , label = .group),
size = 3, position = position_dodge(0.9),
hjust = 1.5,
vjust = -2)+
scale_y_continuous(expand = expansion(mult = c(0, .1)))+
facet_wrap(~Line, nrow=2)+
theme_classic()
print(p)
p<-my_summary %>% mutate(Line = fct_relevel(Line, target_order)) %>%
ggplot(aes(x=param, y=value))+
geom_col(aes(x=param, y=value), color="dark grey", fill="white")+
geom_quasirandom(data = df_data_long, aes(x = param, y = value),
color="green", width = 0.3, alpha = 0.6)+
geom_linerange(aes(x = as.factor(param), ymin=value-ci, ymax=value+ci),
width=.2, position=position_dodge(0.9), color = "black") +
geom_text(data = tuk.cld,
aes(x = Line, y= tuk.cld$emmean , label = .group),
size = 3, position = position_dodge(0.9),
hjust = 1.5,
vjust = -2)+
scale_y_continuous(expand = expansion(mult = c(0, .1)))+
facet_wrap(~Line, nrow=2)+
theme_classic()
print(p)
p<-my_summary %>% mutate(Line = fct_relevel(Line, target_order)) %>%
ggplot(aes(x=param, y=value))+
geom_col(aes(x=param, y=value), color="dark grey", fill="white")+
geom_quasirandom(data = df_data_long, aes(x = param, y = value),
color="green", width = 0.3, alpha = 0.6)+
geom_linerange(aes(x = as.factor(param), ymin=value-ci, ymax=value+ci),
width=.2, position=position_dodge(0.9), color = "black") +
geom_text(data = tuk.cld,
aes(x = param, y= tuk.cld$emmean , label = .group),
size = 3, position = position_dodge(0.9),
hjust = 1.5,
vjust = -2)+
scale_y_continuous(expand = expansion(mult = c(0, .1)))+
facet_wrap(~Line, nrow=2)+
theme_classic()
print(p)
runApp('~/Documents/github-repositories/shiny_fluorcam')
conf_int <- groupwiseMedian(data = df_data_long,
var = "value",
group = c("param", "Line"),
conf       = 0.95,
R          = 5000,
percentile = TRUE,
bca        = FALSE,
digits     = 3)
View(conf_int)
runApp('~/Documents/github-repositories/shiny_fluorcam')
runApp('~/Documents/github-repositories/shiny_fluorcam')
runApp('~/Documents/github-repositories/shiny_fluorcam')
runApp('~/Documents/github-repositories/shiny_fluorcam')
runApp('~/Documents/github-repositories/shiny_fluorcam')
runApp('~/Documents/github-repositories/shiny_fluorcam')
